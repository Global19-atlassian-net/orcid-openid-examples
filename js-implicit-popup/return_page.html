<script src="https://kjur.github.io/jsrsasign/jsrsasign-latest-all-min.js"></script>
<script>
//This page takes an ORCID OAuth response and sends the verified id_token to the parent window.
//The parent window then closes this page
var clientId = "APP-6LKIJ3I5B1C4YIQP";
var orcidCert = {"kty":"RSA","e":"AQAB","use":"sig","kid":"qa-orcid-org-r9afl7qf6hcg7g9ngszu5nt7gzf0ea6i","n":"wyMBMaxlHcZQ2tsbRWdmPF3IMf0rCj9y-NdxmZiuznQQkr0VTOfnf64WMJuhrORoBcFC_Y_G2ZHeDEag8fHjRoW0MVnX0rjcbbwCKenE3BNSsh3qwU1TJ-8SnZ_gsR1XFEqFvK371fE1qAw0UfqmEfVyMG07FZGQSUcUC8kVtXelgyhAlz4jbqW5SgnomlSYuwmcqKqj2ciib8713fePjujTPeuq7vpxXV7wmiHJ3aVyB5EWsX9dIm7JTknxceH9jjSM_JmeoszXX7oZqDcHUWoWbhmb4Ul4OZ25Eq7UQy48WLpTS5Ycz1FuEHuT8xUKDoL1L16293Ai-AY0dj2TDw"};
var pubKey = KEYUTIL.getKey(orcidCert);

function getFragmentParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\#&]" + name + "=([^&#]*)"),
        results = regex.exec(window.location.hash);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function checkSig(idToken){
  return KJUR.jws.JWS.verifyJWT(idToken, pubKey, {
    alg: ['RS256'], iss: ["https:\/\/orcid.org"] , aud:clientId,gracePeriod: 15*60 //15 mins skew allowed
  });
}

var id_token = getFragmentParameterByName("id_token");
if (checkSig(id_token)){
  window.opener.onOrcidAuth(JSON.parse(KJUR.jws.JWS.parse(id_token).payloadPP));      
}else{
  window.opener.onOrcidAuthFail();     
}
</script>